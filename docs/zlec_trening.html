<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Zleƒá trening</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    .form-group { margin-bottom: 1em; }
    label { display: block; margin-bottom: 0.3em; }
    input, select, textarea { padding: 0.5em; width: 100%; box-sizing: border-box; }
    .etap {
      border: 1px solid #ccc;
      padding: 1em;
      margin-bottom: 1em;
      border-radius: 4px;
    }
    .etap h3 { margin-top: 0; }
    button { padding: 0.7em 1.2em; margin-right: 0.5em; margin-top: 1em; }
  </style>
</head>
<body>
  <div class="container">
    <h2>Zleƒá trening</h2>
    <form id="trening-form">
      <div class="form-group">
        <label>Wybierz zawodnika:</label>
        <select id="zawodnik" required></select>
      </div>

      <div class="form-group">
        <label>Data treningu:</label>
        <input type="date" id="data_treningu" required />
      </div>

      <div class="form-group">
        <label>Ilo≈õƒá etap√≥w:</label>
        <input type="number" id="ile_etapow" min="1" value="1" required />
      </div>

      <div class="form-group">
        <label>Uwagi (opcjonalne):</label>
        <textarea id="uwagi"></textarea>
      </div>

      <div id="etapy-container"></div>

      <button type="button" id="generuj-etapy">Generuj etapy</button>
      <button type="submit">Zatwierd≈∫ i zleƒá trening</button>
    </form>
  </div>



<script type="module">
import { supabase } from './supabase.js';

/* =======================================
   FUNKCJE WALIDUJƒÑCE
======================================= */
function validateTime(str) { return /^\d{1,2}:\d{2}$/.test(str); }
function validateFloat(str) { return /^\d+(\.\d+)?$/.test(str); }
function validateInt(str) { return /^\d+$/.test(str); }

/* =======================================
   STAN
======================================= */
let typy = [];
let parametry = {};

/* =======================================
   START
======================================= */
document.addEventListener("DOMContentLoaded", async () => {
  await loadZawodnicy();
  await loadTypyIParametry();
});

/* =======================================
   ≈ÅADOWANIE ZAWODNIK√ìW
======================================= */
async function loadZawodnicy() {
  const { data: { user }} = await supabase.auth.getUser();

  const { data: trener } = await supabase
    .from("trener")
    .select("id_trenera")
    .eq("user_id", user.id)
    .single();

  window.trenerId = trener.id_trenera;

  const { data: zawodnicy } = await supabase
    .from("zawodnik")
    .select("id_zawodnika, imiƒô")
    .eq("id_trenera", trener.id_trenera);

  const sel = document.getElementById("zawodnik");
  zawodnicy.forEach(z => {
    const opt = document.createElement("option");
    opt.value = z.id_zawodnika;
    opt.textContent = z.imiƒô;
    sel.appendChild(opt);
  });
}

/* =======================================
   ≈ÅADOWANIE TYP√ìW I PARAMETR√ìW
======================================= */
async function loadTypyIParametry() {
  const { data: t } = await supabase
    .from("typtreningu")
    .select("id_typutreningu, nazwa");

  typy = t;

  for (const tt of typy) {
    const { data: p } = await supabase
      .from("parametrytyputreningu")
      .select("id_parametr√≥wtt, nazwaparametru")
      .eq("id_typutreningu", tt.id_typutreningu);

    parametry[tt.id_typutreningu] = p;
  }
}

/* =======================================
   GENEROWANIE ETAP√ìW
======================================= */
document.getElementById("generuj-etapy").addEventListener("click", generateEtapy);

function generateEtapy() {
  const n = Number(document.getElementById("ile_etapow").value);
  const container = document.getElementById("etapy-container");
  container.innerHTML = "";

  for (let i = 1; i <= n; i++) {
    const div = document.createElement("div");
    div.className = "etap";
    div.dataset.etap = i;

    div.innerHTML = `
      <h3>Etap ${i}</h3>

      <div class="form-group">
        <label>Typ treningu:</label>
        <select class="typtr" required>
          <option value="">-- wybierz typ --</option>
          ${typy.map(tt => `<option value="${tt.id_typutreningu}">${tt.nazwa}</option>`).join("")}
        </select>
      </div>

      <div class="parametry"></div>
    `;

    container.appendChild(div);
    div.querySelector(".typtr").addEventListener("change", onTypChange);
  }
}

/* =======================================
   GENEROWANIE PARAMETR√ìW
======================================= */
function onTypChange(e) {
  const select = e.target;
  const etapDiv = select.closest(".etap");
  const idTypu = select.value;
  const paramsDiv = etapDiv.querySelector(".parametry");

  paramsDiv.innerHTML = "";

  if (!idTypu) return;

  // üî• je≈õli TEMPO ‚Üí pokazujemy TRYB (czas/dystans)
  if (idTypu == 2) {
    paramsDiv.innerHTML += `
      <div class="form-group">
        <label>Trening wed≈Çug:</label>
        <select class="tryb-wykonania" required>
          <option value="czas">Czasu</option>
          <option value="dystans">Dystansu</option>
        </select>
      </div>
    `;
  }

  // generowanie podstawowych parametr√≥w ‚Äî jak dotychczas
  for (const p of parametry[idTypu]) {
    const name = p.nazwaparametru.toLowerCase();
    let placeholder = "";
    let type = "text";

    if (["tempo", "czas", "czasprzerwy"].includes(name)) placeholder = "mm:ss";
    else if (["dystans", "dystansprzerwy"].includes(name)) { placeholder = "np. 5.20"; type = "number"; }
    else if (["ilosc_powtorzen", "tƒôtno"].includes(name)) { placeholder = "np. 140"; type = "number"; }

    paramsDiv.innerHTML += `
      <div class="form-group">
        <label>${p.nazwaparametru}:</label>
        <input type="${type}" name="param-${etapDiv.dataset.etap}-${p.id_parametr√≥wtt}" placeholder="${placeholder}" step="0.01" required />
      </div>
    `;
  }
}

/* =======================================
   WALIDACJA PRZED ZAPISEM
======================================= */
async function validateBeforeInsert() {
  const errors = [];

  for (const div of document.querySelectorAll(".etap")) {
    const etapNr = div.dataset.etap;
    const idTypu = div.querySelector(".typtr").value;
    if (!idTypu) { errors.push(`Etap ${etapNr}: brak typu treningu.`); continue; }

    for (const inp of div.querySelectorAll("input[name]")) {
      const val = inp.value.trim();
      const idParam = inp.name.split("-")[2];
      const paramObj = parametry[idTypu].find(p => p.id_parametr√≥wtt == idParam);
      const name = paramObj.nazwaparametru.toLowerCase();

      if (["tempo", "czas", "czasprzerwy"].includes(name) && !validateTime(val))
        errors.push(`Etap ${etapNr}: ${name} musi byƒá w formacie mm:ss`);

      if (["dystans", "dystansprzerwy"].includes(name) && !validateFloat(val))
        errors.push(`Etap ${etapNr}: ${name} musi byƒá liczbƒÖ np. 5.20`);

      if (["tƒôtno", "ilosc_powtorzen"].includes(name) && !validateInt(val))
        errors.push(`Etap ${etapNr}: ${name} musi byƒá liczbƒÖ ca≈ÇkowitƒÖ`);
    }
  }

  if (errors.length) {
    alert("Popraw b≈Çƒôdy:\n\n" + errors.join("\n"));
    return false;
  }
  return true;
}

/* =======================================
   ZAPIS TRENINGU
======================================= */
document.getElementById("trening-form").addEventListener("submit", submitForm);

async function submitForm(e) {
  e.preventDefault();

  if (!(await validateBeforeInsert())) return;

  // 1) Zapis treningu g≈Ç√≥wnego
  const { data: tData, error: tErr } = await supabase
    .from("treningdowykonania")
    .insert([{
      id_zawodnika: document.getElementById("zawodnik").value,
      data_treningudw: document.getElementById("data_treningu").value,
      ileetap√≥w_treningudw: Number(document.getElementById("ile_etapow").value),
      id_trenera: window.trenerId,
      uwagi_treningudw: document.getElementById("uwagi").value || null
    }])
    .select()
    .single();

  if (tErr) return alert("B≈ÇƒÖd tworzenia treningu: " + tErr.message);

  const treningId = tData.id_treningudw;

  // 2) Zapis etap√≥w + trybu + parametr√≥w
  for (const div of document.querySelectorAll(".etap")) {
    const etapNr = Number(div.dataset.etap);
    const idTypu = div.querySelector(".typtr").value;

    let tryb = null;
    if (idTypu == 2) tryb = div.querySelector(".tryb-wykonania").value;

    const { data: eData, error: eErr } = await supabase
      .from("etapdowykonania")
      .insert([{
        id_treningudw: treningId,
        id_typutreningu: idTypu,
        kolejnosc_etapu: etapNr,
        tryb_wykonania: tryb
      }])
      .select()
      .single();

    if (eErr) return alert(`B≈ÇƒÖd zapisu etapu ${etapNr}: ` + eErr.message);

    const etapId = eData.id_etapudw;

    const paramInserts = [];
    for (const inp of div.querySelectorAll("input[name]")) {
      const id_param = inp.name.split("-")[2];
      paramInserts.push({
        id_etapudw: etapId,
        id_parametr√≥wtt: id_param,
        wartosc_parametru: inp.value.trim()
      });
    }

    if (paramInserts.length) {
      const { error: pErr } = await supabase
        .from("parametryetapudowykonania")
        .insert(paramInserts);

      if (pErr) return alert(`B≈ÇƒÖd parametr√≥w etapu ${etapNr}: ` + pErr.message);
    }
  }

  alert("Trening zosta≈Ç zlecony!");
  window.location.href = "dashboard.html";
}

</script>
</body>
</html>






