<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Treningi do wykonania</title>
  <link rel="stylesheet" href="style.css" />
</head>

<body>
<div class="container">
  <h2>Treningi do wykonania</h2>
  <p id="info-user" style="opacity:0.8;"></p>

  <p style="margin-top:10px;">
    Poniżej widzisz treningi zaplanowane na najbliższe 7 dni (łącznie z dzisiaj).
  </p>

  <div id="no-trainings" style="display:none; margin-top:20px; font-style:italic;">
    Brak zaplanowanych treningów w najbliższych 7 dniach.
  </div>

  <div id="training-list" class="training-list"></div>

  <a href="dashboard.html" class="back-link">← Wróć do panelu</a>
</div>

<script type="module">
import { supabase } from "./supabase.js";

document.addEventListener("DOMContentLoaded", initPage);

// -------------------- POMOCNIK DO POPRAWNEGO ISO --------------------
function localISODate(d) {
  return new Date(d.getTime() - d.getTimezoneOffset() * 60000)
    .toISOString()
    .slice(0, 10);
}

// -------------------- START --------------------
async function initPage() {
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) {
    window.location.href = "login.html";
    return;
  }

  // Pobranie zawodnika
  const { data: zawodnik } = await supabase
    .from("zawodnik")
    .select("id_zawodnika, imię")
    .eq("user_id", user.id)
    .maybeSingle();

  if (!zawodnik) {
    const nd = document.getElementById("no-trainings");
    nd.textContent = "To konto nie jest powiązane z zawodnikiem.";
    nd.style.display = "block";
    return;
  }

  document.getElementById("info-user").textContent =
    `Zalogowany jako: ${zawodnik.imię}`;

  // -------------------- FILTROWANIE DAT --------------------
  const today = new Date();
  today.setHours(0, 0, 0, 0);

  const end = new Date(today);
  end.setDate(end.getDate() + 6);

  const startStr = localISODate(today);
  const endStr = localISODate(end);

  // -------------------- POBIERAMY WYKONANE TRENINGI --------------------
  const { data: wykonane } = await supabase
    .from("treningwykonany")
    .select("id_treningudw")
    .eq("id_zawodnika", zawodnik.id_zawodnika);

  const wykonaneIDs = new Set(wykonane?.map(x => x.id_treninguw));

  // -------------------- POBIERAMY TRENINGI PLANOWANE --------------------
  const { data: treningi, error: errT } = await supabase
    .from("treningdowykonania")
    .select("id_treningudw, data_treningudw, ileetapów_treningudw, uwagi_treningudw")
    .eq("id_zawodnika", zawodnik.id_zawodnika)
    .gte("data_treningudw", startStr)
    .lte("data_treningudw", endStr)
    .order("data_treningudw", { ascending: true });

  if (errT) {
    console.error(errT);
    document.getElementById("no-trainings").textContent = "Błąd ładowania treningów.";
    document.getElementById("no-trainings").style.display = "block";
    return;
  }

  // -------------------- FILTR: USUWAMY WYKONANE TRENINGI --------------------
  const treningiDoWyswietlenia = treningi.filter(
    t => !wykonaneIDs.has(t.id_treningudw)
  );

  if (treningiDoWyswietlenia.length === 0) {
    document.getElementById("no-trainings").style.display = "block";
    return;
  }

  const listDiv = document.getElementById("training-list");
  listDiv.innerHTML = "";

  // Pobieramy słownik typów
  const { data: typy } = await supabase
    .from("typtreningu")
    .select("id_typutreningu, nazwa");

  const typMap = {};
  typy?.forEach(t => typMap[t.id_typutreningu] = t.nazwa);

  // -------------------- RENDER KART --------------------
  for (const tr of treningiDoWyswietlenia) {
    const card = document.createElement("div");
    card.className = "card training-card";

    card.innerHTML = `
      <div class="training-header">
        <div>Data: ${formatDate(tr.data_treningudw)}</div>
        <div>Etapy: ${tr.ileetapów_treningudw}</div>
      </div>
      ${tr.uwagi_treningudw
        ? `<p class="training-meta"><strong>Uwagi trenera:</strong> ${tr.uwagi_treningudw}</p>`
        : ""
      }
      <div class="stages"><em>Ładowanie etapów…</em></div>
    `;

    listDiv.appendChild(card);
    await loadEtapy(tr.id_treningudw, typMap, card.querySelector(".stages"));
  }
}

// -------------------- FORMAT DATY --------------------
function formatDate(iso) {
  if (!iso) return "-";
  const d = new Date(iso);
  return d.toLocaleDateString("pl-PL");
}

// -------------------- ŁADOWANIE ETAPÓW --------------------
async function loadEtapy(idTreningu, typMap, stagesDiv) {
  stagesDiv.innerHTML = "";

  const { data: etapy } = await supabase
    .from("etapdowykonania")
    .select("id_etapudw, id_typutreningu, kolejnosc_etapu")
    .eq("id_treningudw", idTreningu)
    .order("kolejnosc_etapu", { ascending: true });

  if (!etapy || etapy.length === 0) {
    stagesDiv.innerHTML = "<p><em>Brak etapów dla tego treningu.</em></p>";
    return;
  }

  for (const etap of etapy) {
    const div = document.createElement("div");
    div.className = "stage";

    const typeName = (typMap[etap.id_typutreningu] || "").toLowerCase();

    div.innerHTML = `<h4>Etap ${etap.kolejnosc_etapu} — ${typMap[etap.id_typutreningu]}</h4>`;

    if (typeName === "wybieganie") {
      await wypelnijWybieganie(etap.id_etapudw, div);
    } else if (typeName === "tempo") {
      await wypelnijTempo(etap.id_etapudw, div);
    } else {
      div.innerHTML += "<p><em>Typ etapu nieobsługiwany.</em></p>";
    }

    stagesDiv.appendChild(div);
  }
}

// -------------------- WIDOK WYBIEGANIE --------------------
async function wypelnijWybieganie(id_etap, div) {
  const { data: row } = await supabase
    .from("vw_etap_wybieganie_plan")
    .select("tempo, dystans, tetno")
    .eq("id_etapudw", id_etap)
    .maybeSingle();

  if (!row) {
    div.innerHTML += "<p><em>Brak danych tego etapu (wybieganie).</em></p>";
    return;
  }

  div.innerHTML += `
    <p><strong>Dystans:</strong> ${row.dystans} km</p>
    <p><strong>Docelowe tempo:</strong> ${row.tempo}</p>
    <p><strong>Tętno:</strong> ${row.tetno} bpm</p>
  `;
}

// -------------------- WIDOK TEMPO --------------------
async function wypelnijTempo(id_etap, div) {
  const { data: row } = await supabase
    .from("vw_etap_tempo_plan")
    .select("dystans, dystans_przerwy, ilosc_powtorzen")
    .eq("id_etapudw", id_etap)
    .maybeSingle();

  if (!row) {
    div.innerHTML += "<p><em>Brak danych tego etapu (tempo).</em></p>";
    return;
  }

  div.innerHTML += `
    <p><strong>Liczba powtórzeń:</strong> ${row.ilosc_powtorzen}</p>
    <p><strong>Odcinek:</strong> ${row.dystans} km</p>
    <p><strong>Przerwa:</strong> ${row.dystans_przerwy} km</p>
  `;
}
</script>

</body>
</html>

