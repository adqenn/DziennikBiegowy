<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dodaj wykonany trening</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    .container { max-width: 700px; margin: auto; padding: 1em; }
    .trening-item { border: 1px solid #444; padding: 10px; margin: 5px 0; border-radius: 5px; }
    .trening-item button { margin-top: 5px; }
    .etap { border: 1px solid #ccc; padding: 1em; margin: 1em 0; border-radius: 4px; }
    .powtorka { border: 1px dashed #888; padding: 0.7em; margin-bottom: 0.5em; border-radius: 3px; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <div class="container">
    <h2>Dodaj wykonany trening</h2>

    <div id="lista-treningow"></div>

    <div id="formularz-wykonania" class="hidden">
      <div id="etapy-container"></div>
      <div>
        <label for="komentarz">Komentarz (opcjonalnie):</label><br/>
        <textarea id="komentarz" rows="3" style="width:100%;"></textarea>
      </div>
      <button id="submit-btn">Zatwierd≈∫ wykonanie</button>
    </div>
  </div>

<script type="module">
import { supabase } from './supabase.js';

/* ===================== WALIDACJE FORMAT√ìW ===================== */

function validateTime(str) {
  return /^\d{1,2}:\d{2}$/.test(str);     // mm:ss
}
function validateFloat(str) {
  return /^\d+(\.\d+)?$/.test(str);       // X.Y
}
function validateInt(str) {
  return /^\d+$/.test(str);               // liczba ca≈Çkowita
}

/* ===================== STAN ===================== */

let dostƒôpneTreningi = [];
let currentEtapy = [];
let currentTreningId = null;

document.addEventListener('DOMContentLoaded', () => {
  loadZleconeTreningi();
});

/* ===================== ≈ÅADOWANIE ZLECONYCH TRENING√ìW ===================== */

async function loadZleconeTreningi() {
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) {
    alert("Nie jeste≈õ zalogowany.");
    return;
  }

  const { data: zawodnik, error: errZ } = await supabase
    .from('zawodnik')
    .select('id_zawodnika')
    .eq('user_id', user.id)
    .single();

  if (errZ || !zawodnik) {
    alert("Nie znaleziono profilu zawodnika.");
    return;
  }

  const { data: treningi, error: errT } = await supabase
    .from('treningdowykonania')
    .select('id_treningudw, data_treningudw, ileetap√≥w_treningudw')
    .eq('id_zawodnika', zawodnik.id_zawodnika)
    .order('data_treningudw', { ascending: false })
    .limit(10);

  if (errT) {
    alert("B≈ÇƒÖd ≈Çadowania zleconych trening√≥w: " + errT.message);
    return;
  }
  if (!treningi || treningi.length === 0) {
    alert("Brak zleconych trening√≥w do dodania.");
    return;
  }

  dostƒôpneTreningi = treningi;
  renderListaTreningow(treningi);
}

function renderListaTreningow(treningi) {
  const div = document.getElementById('lista-treningow');
  div.innerHTML = '';

  const dzis = new Date();
  dzis.setHours(0, 0, 0, 0);

  const przyszle = treningi.filter(t => {
    const d = new Date(t.data_treningudw);
    d.setHours(0, 0, 0, 0);
    return d >= dzis;
  });

  const posortowane = przyszle.sort(
    (a, b) => new Date(a.data_treningudw) - new Date(b.data_treningudw)
  );

  const ograniczone = posortowane.slice(0, 3);

  ograniczone.forEach(t => {
    const item = document.createElement('div');
    item.className = 'trening-item';
    item.innerHTML = `
      <strong>Data:</strong> ${new Date(t.data_treningudw).toLocaleDateString('pl-PL')}<br/>
      <strong>Etapy:</strong> ${t.ileetap√≥w_treningudw}<br/>
      <button data-id="${t.id_treningudw}">Wybierz ten trening</button>
    `;
    div.appendChild(item);

    item.querySelector('button').addEventListener('click', () => {
      onTreningSelect(t.id_treningudw);
    });
  });
}

/* ===================== WYB√ìR TRENINGU ===================== */

async function onTreningSelect(treningId) {
  currentTreningId = treningId;

  document.getElementById('lista-treningow').classList.add('hidden');
  document.getElementById('formularz-wykonania').classList.remove('hidden');

  const { data: etapy, error: errE } = await supabase
    .from('etapdowykonania')
    .select('id_etapudw, id_typutreningu, kolejnosc_etapu, tryb_wykonania')
    .eq('id_treningudw', treningId)
    .order('kolejnosc_etapu', { ascending: true });

  if (errE) {
    alert("B≈ÇƒÖd ≈Çadowania etap√≥w: " + errE.message);
    return;
  }
  if (!etapy || etapy.length === 0) {
    alert("Wybrany trening nie ma etap√≥w.");
    return;
  }

  currentEtapy = etapy;
  const container = document.getElementById('etapy-container');
  container.innerHTML = '';

  for (let i = 0; i < etapy.length; i++) {
    await renderEtapForm(etapy[i], i + 1, container);
  }

  document.getElementById('submit-btn').onclick = submitTrening;
}

/* ===================== RENDER FORMULARZA DLA ETAPU ===================== */

async function renderEtapForm(etap, numer, container) {
  const { data: typ } = await supabase
    .from('typtreningu')
    .select('nazwa')
    .eq('id_typutreningu', etap.id_typutreningu)
    .single();

  const nazwa = typ?.nazwa?.toLowerCase() || '‚Äî';

  const div = document.createElement('div');
  div.className = 'etap';
  div.innerHTML = `<h3>Etap ${etap.kolejnosc_etapu} ‚Äî ${typ?.nazwa}</h3>`;

  
/* ----- TEMPO (z trybem wykonywania) ----- */
if (nazwa === 'tempo') {

  const { data: plan, error: errP } = await supabase
    .from('vw_etap_tempo_plan')
    .select('ilosc_powtorzen, czas, czas_przerwy, dystans, dystans_przerwy')
    .eq('id_etapudw', etap.id_etapudw)
    .single();

  if (errP || !plan) {
    div.innerHTML += `<p><em>B≈ÇƒÖd ≈Çadowania planu tempo.</em></p>`;
    container.appendChild(div);
    return;
  }

  const ile = parseInt(plan.ilosc_powtorzen || 1);
  const tryb = etap.tryb_wykonania;   // üî• NOWE!

  // opis planu jak dotychczas
  div.innerHTML += `
    <p style="opacity:0.7;"><strong>Czas odcinka:</strong> ${plan.czas}</p>
    <p style="opacity:0.7;"><strong>Czas przerwy:</strong> ${plan.czas_przerwy}</p>
    <p style="opacity:0.7;"><strong>Dystans:</strong> ${plan.dystans} km</p>
    <p style="opacity:0.7;"><strong>Dystans przerwy:</strong> ${plan.dystans_przerwy} km</p>
    <p style="opacity:0.7;"><strong>Ilo≈õƒá powt√≥rze≈Ñ:</strong> ${ile}</p>

    <p style="margin-top:10px;">
      <strong>Trening wed≈Çug:</strong>
      ${tryb === 'czas' ? '‚è± czasu' : 'üìè dystansu'}
    </p>
    <hr/>
  `;

  // üî• generowanie odpowiednich p√≥l zale≈ºnie od trybu
  for (let i = 1; i <= ile; i++) {
    const block = document.createElement('div');
    block.className = "powtorka";

    if (tryb === 'czas') {
      // ----------------------------------------------------
      // TRYB ‚ÄûCZAS‚Äù ‚Üí zawodnik wpisuje CZAS, CZAS PRZERWY
      // ----------------------------------------------------
      block.innerHTML = `
        <h4>Powt√≥rzenie ${i}</h4>

        <label>Czas ${i} (mm:ss):</label>
        <input type="text" name="czas-${etap.id_etapudw}-${i}" placeholder="np. 1:10" required />

        <label>Czas przerwy ${i} (mm:ss):</label>
        <input type="text" name="przerwa-${etap.id_etapudw}-${i}" placeholder="np. 1:00" required />
      `;
    }

    else if (tryb === 'dystans') {
      // ----------------------------------------------------
      // TRYB ‚ÄûDYSTANS‚Äù ‚Üí zawodnik wpisuje DYSTANSY
      // ----------------------------------------------------
      block.innerHTML = `
        <h4>Powt√≥rzenie ${i}</h4>

        <label>Dystans ${i} (km):</label>
        <input type="number" step="0.01" name="dyst-${etap.id_etapudw}-${i}" placeholder="np. 0.40" required />

        <label>Dystans przerwy ${i} (km):</label>
        <input type="number" step="0.01" name="dystp-${etap.id_etapudw}-${i}" placeholder="np. 0.20" required />
      `;
    }

    div.appendChild(block);
  }
}



/* ----- WYBIEGANIE ----- */
else if (nazwa === 'wybieganie') {
  // üîµ plan z widoku vw_etap_wybieganie_plan
  const { data: planW, error: errW } = await supabase
    .from('vw_etap_wybieganie_plan')
    .select('tempo, dystans, tetno')
    .eq('id_etapudw', etap.id_etapudw)
    .single();

  if (!errW && planW) {
    div.innerHTML += `
      <p style="opacity: 0.7;"><strong>Tempo planowe:</strong> ${planW.tempo}</p>
      <p style="opacity: 0.7;"><strong>Dystans:</strong> ${planW.dystans} km</p>
      <p style="opacity: 0.7;"><strong>Tƒôtno:</strong> ${planW.tetno}</p>
      <hr />
    `;
  }

  div.innerHTML += `
    <div class="form-group">
      <label>Tempo (mm:ss):</label>
      <input type="text" name="tempo-${etap.id_etapudw}" placeholder="np. 5:30" required />
    </div>

    <div class="form-group">
      <label>Dystans (km):</label>
      <input type="number" step="0.01" name="dystans-${etap.id_etapudw}" placeholder="np. 8.50" required />
    </div>

    <div class="form-group">
      <label>Tƒôtno (bpm):</label>
      <input type="number" name="tetno-${etap.id_etapudw}" placeholder="np. 140" required />
    </div>
  `;
}
 else {
    div.innerHTML += `<p><em>Typ "${nazwa}" nie jest jeszcze obs≈Çugiwany.</em></p>`;
  }

  container.appendChild(div);
}

/* ===================== WALIDACJA CA≈ÅEGO TRENINGU (PRZED ZAPISEM) ===================== */

async function validateAllInputs() {
  const errors = [];

  for (let etap of currentEtapy) {
    const { data: typ, error: errT } = await supabase
      .from('typtreningu')
      .select('nazwa')
      .eq('id_typutreningu', etap.id_typutreningu)
      .single();

    if (errT || !typ) {
      errors.push(`Etap ${etap.kolejnosc_etapu}: b≈ÇƒÖd odczytu typu treningu.`);
      continue;
    }

    const typN = typ.nazwa?.toLowerCase();

    if (typN === 'wybieganie') {
      const tempo = document.querySelector(`[name="tempo-${etap.id_etapudw}"]`)?.value.trim() || '';
      const dystans = document.querySelector(`[name="dystans-${etap.id_etapudw}"]`)?.value.trim() || '';
      const tetno = document.querySelector(`[name="tetno-${etap.id_etapudw}"]`)?.value.trim() || '';

      if (!validateTime(tempo)) {
        errors.push(`Etap ${etap.kolejnosc_etapu}: tempo musi byƒá w formacie mm:ss`);
      }
      if (!validateFloat(dystans)) {
        errors.push(`Etap ${etap.kolejnosc_etapu}: dystans musi byƒá liczbƒÖ z kropkƒÖ`);
      }
      if (!validateInt(tetno)) {
        errors.push(`Etap ${etap.kolejnosc_etapu}: tƒôtno musi byƒá liczbƒÖ ca≈ÇkowitƒÖ`);
      }
    } else if (typN === 'tempo') {
  const { data: planTempo } = await supabase
    .from('vw_etap_tempo_plan')
    .select('ilosc_powtorzen')
    .eq('id_etapudw', etap.id_etapudw)
    .single();

  const ilosc = planTempo?.ilosc_powtorzen || 1;
  const tryb = etap.tryb_wykonania;

  for (let i = 1; i <= ilosc; i++) {

    if (tryb === 'czas') {
      const czas = document.querySelector(`[name="czas-${etap.id_etapudw}-${i}"]`)?.value.trim();
      const przerwa = document.querySelector(`[name="przerwa-${etap.id_etapudw}-${i}"]`)?.value.trim();

      if (!validateTime(czas))
        errors.push(`Etap ${etap.kolejnosc_etapu}: czas ${i} ma z≈Çy format.`);
      if (!validateTime(przerwa))
        errors.push(`Etap ${etap.kolejnosc_etapu}: przerwa ${i} ma z≈Çy format.`);
    }

    if (tryb === 'dystans') {
      const dyst = document.querySelector(`[name="dyst-${etap.id_etapudw}-${i}"]`)?.value.trim();
      const dystp = document.querySelector(`[name="dystp-${etap.id_etapudw}-${i}"]`)?.value.trim();

      if (!validateFloat(dyst))
        errors.push(`Etap ${etap.kolejnosc_etapu}: dystans ${i} jest niepoprawny.`);
      if (!validateFloat(dystp))
        errors.push(`Etap ${etap.kolejnosc_etapu}: dystans przerwy ${i} jest niepoprawny.`);
    }
  }
}

  }

  if (errors.length > 0) {
    alert("Nie zapisano treningu. Popraw nastƒôpujƒÖce b≈Çƒôdy:\n\n" + errors.join("\n"));
    return false;
  }

  return true;
}

/* ===================== ZAPIS WYKONANIA TRENINGU ===================== */

async function submitTrening() {
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) {
    alert("B≈ÇƒÖd: u≈ºytkownik nie jest zalogowany.");
    return;
  }

  // 1) Walidacja CA≈ÅEGO formularza PRZED pierwszym INSERT-em
  const ok = await validateAllInputs();
  if (!ok) {
    return; // NIC nie zapisujemy
  }

  // 2) Dopiero teraz ‚Äì odczyt zawodnika i zapisy
  const { data: zawodnik, error: errZ } = await supabase
    .from('zawodnik')
    .select('id_zawodnika, id_trenera')
    .eq('user_id', user.id)
    .single();

  if (errZ || !zawodnik) {
    alert("B≈ÇƒÖd: nie znaleziono profilu zawodnika.");
    return;
  }

  const { data: treningW, error: errTW } = await supabase
    .from('treningwykonany')
    .insert({
      id_treningudw: currentTreningId,         // üî¥ POPRAWIONE: kolumna w bazie
      id_zawodnika: zawodnik.id_zawodnika,
      data_treninguw: new Date().toISOString(),
      uwagi: document.getElementById('komentarz').value || null,
      id_trenera: zawodnik.id_trenera,
      ileetap√≥w_treninguw: currentEtapy.length
    })
    .select()
    .single();

  if (errTW) {
    if (errTW.code === '23505') {
      alert("Ten trening zosta≈Ç ju≈º przez Ciebie wykonany.");
    } else {
      alert("B≈ÇƒÖd zapisu treningu wykonanego: " + errTW.message);
    }
    return;
  }

  const idTreningW = treningW.id_treningwykonany;

  /* ----- iteracja po etapach ----- */
  for (let etap of currentEtapy) {
    const { data: etapW, error: errEW } = await supabase
      .from('etapwykonany')
      .insert({
        id_treninguw: idTreningW,
        id_typutreningu: etap.id_typutreningu,
        kolejnosc_etapu: etap.kolejnosc_etapu
      })
      .select()
      .single();

    if (errEW) {
      alert("B≈ÇƒÖd zapisu etapu: " + errEW.message);
      return;
    }

    const idEtapuW = etapW.id_etapuw;

    const { data: typ } = await supabase
      .from('typtreningu')
      .select('nazwa')
      .eq('id_typutreningu', etap.id_typutreningu)
      .single();

    const typN = typ?.nazwa?.toLowerCase();

    /* ------------ WYBIEGANIE ------------ */
    if (typN === "wybieganie") {
      const tempo = document.querySelector(`[name="tempo-${etap.id_etapudw}"]`)?.value.trim();
      const dystans = document.querySelector(`[name="dystans-${etap.id_etapudw}"]`)?.value.trim();
      const tetno = document.querySelector(`[name="tetno-${etap.id_etapudw}"]`)?.value.trim();

      // dodatkowa kontrola (nie powinna ju≈º wyj≈õƒá po pre-walidacji)
      if (!validateTime(tempo) || !validateFloat(dystans) || !validateInt(tetno)) {
        alert(`Wykryto nieprawid≈Çowe dane w etapie ${etap.kolejnosc_etapu}. Trening nie zosta≈Ç zapisany w ca≈Ço≈õci.`);
        return;
      }

      const parametry = [
        { nazwa: 'tempo', wartosc: tempo },
        { nazwa: 'dystans', wartosc: dystans },
        { nazwa: 'tƒôtno', wartosc: tetno }
      ];

      for (let p of parametry) {
        const { data: par, error: errPar } = await supabase
          .from('parametrytyputreningu')
          .select('id_parametr√≥wtt')
          .eq('nazwaparametru', p.nazwa)
          .eq('id_typutreningu', etap.id_typutreningu)
          .single();

        if (errPar || !par) {
          console.error("Brak parametru:", p.nazwa, errPar);
          continue;
        }

        await supabase.from('parametryetapuwykonanego').insert({
          id_etapuw: idEtapuW,
          id_parametr√≥wtt: par.id_parametr√≥wtt,
          wartosc_parametru: p.wartosc
        });
      }
    }

    /* ------------ TEMPO ------------ */
else if (typN === "tempo") {

  const { data: planTempo } = await supabase
    .from('vw_etap_tempo_plan')
    .select('ilosc_powtorzen, czas, czas_przerwy, dystans, dystans_przerwy')
    .eq('id_etapudw', etap.id_etapudw)
    .single();

  const tryb = etap.tryb_wykonania;
  const ilosc = planTempo?.ilosc_powtorzen || 1;

  for (let i = 1; i <= ilosc; i++) {

    let wartosci = [];

    if (tryb === 'czas') {
      wartosci = [
        { nazwa: "czas", wartosc: document.querySelector(`[name="czas-${etap.id_etapudw}-${i}"]`).value.trim() },
        { nazwa: "czasprzerwy", wartosc: document.querySelector(`[name="przerwa-${etap.id_etapudw}-${i}"]`).value.trim() },
        { nazwa: "dystans", wartosc: planTempo.dystans },
        { nazwa: "dystansprzerwy", wartosc: planTempo.dystans_przerwy }
      ];
    }

    if (tryb === 'dystans') {
      wartosci = [
        { nazwa: "dystans", wartosc: document.querySelector(`[name="dyst-${etap.id_etapudw}-${i}"]`).value.trim() },
        { nazwa: "dystansprzerwy", wartosc: document.querySelector(`[name="dystp-${etap.id_etapudw}-${i}"]`).value.trim() },
        { nazwa: "czas", wartosc: planTempo.czas },
        { nazwa: "czasprzerwy", wartosc: planTempo.czas_przerwy }
      ];
    }

    wartosci.push({ nazwa: "ilosc_powtorzen", wartosc: i.toString() });

    for (let z of wartosci) {
      const { data: par } = await supabase
        .from('parametrytyputreningu')
        .select('id_parametr√≥wtt')
        .eq('nazwaparametru', z.nazwa)
        .eq('id_typutreningu', etap.id_typutreningu)
        .single();

      await supabase.from('parametryetapuwykonanego').insert({
        id_etapuw: idEtapuW,
        id_parametr√≥wtt: par.id_parametr√≥wtt,
        wartosc_parametru: z.wartosc
      });
    }
  }
}

  }

  alert("Trening zapisany pomy≈õlnie!");
  location.reload();
}
</script>

</body>
</html>

